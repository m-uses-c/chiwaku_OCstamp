<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta http-equiv="x-ua-compatible" content="ie=edge" />
        <title>ちわくOCスタンプラリー</title>
        <!-- MDB icon -->
        <link rel="icon" href="img/chiwaku_cf.ico" type="image/x-icon" />
        <!-- Font Awesome -->
        <link
                rel="stylesheet"
                href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
                />
        <!-- Google Fonts Roboto -->
        <link
                rel="stylesheet"
                href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap"
                />
        <link
                rel="stylesheet"
                href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic"
                />
        <!-- MDB -->
        <link rel="stylesheet" href="css/mdb.min.css" />
        <style>
        body {
            font-family: 'Zen Maru Gothic';
        }
        #githubLink {
            position: absolute;
            right: 0;
            top: 12px;
            color: #2D99FF;
        }

        #loadingMessage {
            text-align: center;
            padding: 40px;
            background-color: #eee;
        }

        #canvas {
            width: 100%;
        }

        #output {
            margin-top: 20px;
            background: #eee;
            padding: 10px;
            padding-bottom: 0;
        }

        #output div {
            padding-bottom: 10px;
            word-wrap: break-word;
        }

        #noQRFound {
            text-align: center;
        }
        </style>
    </head>
    <body>
    <!-- Start your project here-->
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <button
                    class="navbar-toggler"
                    type="button"
                    data-mdb-toggle="collapse"
                    data-mdb-target="#navbarSupportedContent"
                    aria-controls="navbarSupportedContent"
                    aria-expanded="false"
                    aria-label="Toggle navigation"
            >
                <i class="fas fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <!--<a class="navbar-brand mt-2 mt-lg-0" href="#">
                <img
                src="https://mdbcdn.b-cdn.net/img/logo/mdb-transaprent-noshadows.webp"
                height="15"
                alt="MDB Logo"
                loading="lazy"
                />
            </a>-->
        <!-- Left links -->
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
                <a class="nav-link" href="./index.html">HOME</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="./about.html">このサイトについて</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="./link.html">link</a>
            </li>
        </ul>
        <!-- Left links -->
        </div>
        <!-- Collapsible wrapper -->
        <!-- Right elements -->
        <div class="d-flex align-items-center">
        <!-- Icon -->
        <!-- <a class="text-reset me-3" href="#">
            <i class="fas fa-camera fa-lg"></i>
        </a> -->
        <button type="button" id="modalbotton-camera" class="btn btn-outline-dark" data-mdb-toggle="modal" data-mdb-target="#exampleModal">
        <i class="fas fa-camera fa-lg"></i>
        </button>
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="moda-title" id="exampleModalLabel">QR読み込み画面</h5>
                        <button type="button" class="btn-close" id="modalbtn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- <span class="close">&times;</span> -->
                        <div id="loadingMessage">unable to access video stream (please make sure you have a webcam enabled)</div>
                        <canvas id="canvas" hidden></canvas>
                        <div id="output" hidden>
                            <div id="outputMessage">No QR code detected.</div>
                            <div hidden><b></b> <span id="outputData"></span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    <!-- Right elements -->
    </div>
    <!-- Container wrapper -->
    </nav>
    <!-- End your project here-->
    <section class="py-2 px-4">
        <div class="row d-flex justify-content-center">
            <div class="col-xl-7 col-md-9 col-sm-9">

                <h3 class="py-4" id="fluidspace">流体圏・宇宙圏科学
                    <img id="fs_i" style="display: none;" src="./img/weather_sunny.png" height="80px">
                </h3>
                <div class="card">
                    <div class="card-body">
                        <p class="card-text">太陽面から、地球の周りの磁気圏までの宇宙天気に関する研究や、地上から数百kmの高さまでの大気の循環、台風や大気海洋相互作用などの流体現象を研究できるグループです。</p>
                    </div>
                    <div class="accordion" id="accordion1">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading1-1">
                                <button class="accordion-button collapsed" type="button" data-mdb-toggle="collapse" data-mdb-target="#collapse1-1" aria-expanded="true" aria-control="collapse1-1">
                                    太陽地球系物理学・宇宙地球電磁気学
                                </button>
                            </h2>
                            <div class="accordion-collapse collapse" id="collapse1-1" aria-labelledby="heading1-1" data-mdb-target="#accordion1">
                                <div class="accordion-body">
                                    <p>
                                    <a class="streched-link" href="http://denji102.geo.kyushu-u.ac.jp/stp/index.html">太陽地球系物理学研究室のHP</a><br>
                                    <a class="streched-link" href="http://denji102.geo.kyushu-u.ac.jp/">宇宙地球電磁気研究室のHP</a><br>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading1-2">
                                <button class="accordion-button collapsed" type="button" data-mdb-toggle="collapse" data-mdb-target="#collapse1-2" aria-expanded="true" aria-control="collapse1-2">
                                    気象学・大気流体力学
                                </button>
                            </h2>
                            <div class="accordion-collapse collapse" id="collapse1-2" aria-labelledby="heading1-2" data-mdb-target="#accordion1">
                                <div class="accordion-body">
                                    <p>
                                    <a class="streched-link" href="http://fujin.geo.kyushu-u.ac.jp/tropo-labo/ja/labo.html">気象学・気候力学研究室のHP</a><br>
                                    <a class="streched-link" href="http://fx.geo.kyushu-u.ac.jp/">大気流体力学研究室のHP</a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <h3 class="py-4" id="solidearth">固体地球惑星科学
                    <img id="se_i" style="display: none;" src="./img/object_earth.png" height="80px">
                </h3>
                <div class="card">
                    <div class="card-body">
                        <p class="card-text">対象は地球の核から地表の岩石まで、地球で起きる幅広い現象を扱うことができます。地震や火山噴火などの現象を地球物理学的側面から扱うだけでなく、地球の46億年の歴史の中のイベントを解き明かすこともできます。</p>
                    </div>
                    <div class="accordion" id="accordion2">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading2-1">
                                <button class="accordion-button collapsed" type="button" data-mdb-toggle="collapse" data-mdb-target="#collapse2-1" aria-expanded="true" aria-control="collapse2-1">
                                    内部ダイナミクス・深部物理
                                </button>
                            </h2>
                            <div class="accordion-collapse collapse" id="collapse2-1" aria-labelledby="heading2-1" data-mdb-target="#accordion2">
                                <div class="accordion-body">
                                    <p>
                                    <a class="streched-link" href="https://sites.google.com/site/geophysics16qu/">地球深部物理学研究室のHP</a><br>
                                    <a class="streched-link" href="http://dyna.geo.kyushu-u.ac.jp/">地球内部ダイナミクス研究室のHP</a></p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading2-2">
                                <button class="accordion-button collapsed" type="button" data-mdb-toggle="collapse" data-mdb-target="#collapse2-2" aria-expanded="true" aria-control="collapse2-2">
                                    岩石循環
                                </button>
                            </h2>
                            <div class="accordion-collapse collapse" id="collapse2-2" aria-labelledby="heading2-2" data-mdb-target="#accordion2">
                                <div class="accordion-body">
                                    <p>
                                    <a class="streched-link" href="http://ganseki3.geo.kyushu-u.ac.jp/index.html">岩石循環科学研究室のHP</a><br>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading2-3">
                                <button class="accordion-button collapsed" type="button" data-mdb-toggle="collapse" data-mdb-target="#collapse2-3" aria-expanded="true" aria-control="collapse2-3">
                                    古環境 &nbsp;<div style="color:grey;">+ 古生物</div>
                                </button>
                            </h2>
                            <div class="accordion-collapse collapse" id="collapse2-3" aria-labelledby="heading2-3" data-mdb-target="#accordion2">
                                <div class="accordion-body">
                                    <p>
                                    <a class="streched-link" href="http://paleobio.geo.kyushu-u.ac.jp/">古環境研究室のHP</a><br>
                                    <a class="streched-link" href="http://www.museum.kyushu-u.ac.jp/index.html">九大総合研究博物館のサイト</a>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading2-4">
                                <button class="accordion-button collapsed" type="button" data-mdb-toggle="collapse" data-mdb-target="#collapse2-4" aria-expanded="true" aria-control="collapse2-4">
                                    地球進化史
                                </button>
                            </h2>
                            <div class="accordion-collapse collapse" id="collapse2-4" aria-labelledby="heading2-4" data-mdb-target="#accordion2">
                                <div class="accordion-body">
                                    <p></p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading2-5">
                                <button class="accordion-button collapsed" type="button" data-mdb-toggle="collapse" data-mdb-target="#collapse2-5" aria-expanded="true" aria-control="collapse2-5">
                                    観測地震・火山
                                </button>
                            </h2>
                            <div class="accordion-collapse collapse" id="collapse2-5" aria-labelledby="heading2-5" data-mdb-target="#accordion2">
                                <div class="accordion-body">
                                    <p>
                                    <a class="streched-link" href="https://sevo.kyushu-u.ac.jp/wp/">地震火山観測研究センターのHP</a>
                                    </p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div> 

                <h3 class="py-4" id="solarsystem">太陽惑星系物質科学
                    <img id="ss_i" style="display: none;" src="./img/object_neptune.png" height="80px">
                </h3>
                <div class="card">
                    <div class="card-body">
                        <p class="card-text">地球内部の岩石から太陽系の隕石まで、主に実験や分析から物質科学的な進化の様子を調べることできます。</p>
                    </div>
                    <div class="accordion" id="accordion3">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading3-1">
                                <button class="accordion-button collapsed" type="button" data-mdb-toggle="collapse" data-mdb-target="#collapse3-1" aria-expanded="true" aria-control="collapse3-1">
                                    有機宇宙地球化学
                                </button>
                            </h2>
                            <div class="accordion-collapse collapse" id="collapse3-1" aria-labelledby="heading3-1" data-mdb-target="#accordion3">
                                <div class="accordion-body">
                                    <p>
                                    <a class="streched-link" href="http://orge.geo.kyushu-u.ac.jp/home.html">有機宇宙地球化学研究室のHP</a>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading3-2">
                                <button class="accordion-button collapsed" type="button" data-mdb-toggle="collapse" data-mdb-target="#collapse3-2" aria-expanded="true" aria-control="collapse3-2">
                                    惑星系形成進化学
                                </button>
                            </h2>
                            <div class="accordion-collapse collapse" id="collapse3-2" aria-labelledby="heading3-2" data-mdb-target="#accordion3">
                                <div class="accordion-body">
                                    <p>
                                    <a class="streched-link" href="https://jupiter.geo.kyushu-u.ac.jp/index.html">惑星系形成進化学研究室のHP</a>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading3-3">
                                <button class="accordion-button collapsed" type="button" data-mdb-toggle="collapse" data-mdb-target="#collapse3-3" aria-expanded="true" aria-control="collapse3-3">
                                    地球システム化学
                                </button>
                            </h2>
                            <div class="accordion-collapse collapse" id="collapse3-3" aria-labelledby="heading3-3" data-mdb-target="#accordion3">
                                <div class="accordion-body">
                                    <p>
                                    <a class="streched-link" href="https://www.sci.kyushu-u.ac.jp/department/geo/labo/inorg.html">地球システム化学研究室のサイト</a>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading3-4">
                                <button class="accordion-button collapsed" type="button" data-mdb-toggle="collapse" data-mdb-target="#collapse3-4" aria-expanded="true" aria-control="collapse3-4">
                                    地球内部物質学
                                </button>
                            </h2>
                            <div class="accordion-collapse collapse" id="collapse3-4" aria-labelledby="heading3-4" data-mdb-target="#accordion3">
                                <div class="accordion-body">
                                    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <figure id="chiwakufigure" style="display: none;padding-top:20pt">
                    <img class="figure-img img-fluid" src="img/chikyu_clear.png"/>
                </figure>

            </div>
        </div>
    </section>
    <script>
        var modal = document.getElementById("exampleModal");
        var openmodalbtn = document.getElementById("modalbotton-camera");
        var closebtn = document.getElementById("modalbtn-close")
        var video = document.createElement("video");
        var canvasElement = document.getElementById("canvas");
        var canvas = canvasElement.getContext("2d");
        var loadingMessage = document.getElementById("loadingMessage");
        var outputContainer = document.getElementById("output");
        var outputMessage = document.getElementById("outputMessage");
        var outputData = document.getElementById("outputData");
        var permissiongranted = false;

        function drawLine(begin, end, color) {
            canvas.beginPath();
            canvas.moveTo(begin.x, begin.y);
            canvas.lineTo(end.x, end.y);
            canvas.lineWidth = 4;
            canvas.strokeStyle = color;
            canvas.stroke();
        }

        // Use facingMode: environment to attemt to get the front camera on phones
        //navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        //        .then(function(stream) {
        //            video.srcObject = stream;
        //            video.setAttribute("playsinline", true); // required to tell iOS safari we don't want fullscreen
        //            video.play();
        //            requestAnimationFrame(tick);
        //        });

        openmodalbtn.onclick = function() {
            modal.style.display = "block";
            startCamera();
        }

        closebtn.onclick = function() {
            modal.style.display = "none";
            stopCamera();
        }

        window.onclick = function() {
            if (event.target == modal) {
                modal.style.display = "none";
                stopCamera();
            }
        }

        function stopCamera() {
            if (video.srcObject) {
                video.pause();
                video.srcObject.getTracks().forEach(function(track) {
                    track.stop();
                });
                video.srcObject = null;
                scanning = false;
                closebtn.click();
            }
        }

        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }})
                .then(function(stream) {
                    video.srcObject = stream;
                    video.setAttribute("playsinline", true); // required to tell iOS safari we don't want fullscreen
                    video.play();
                    scanning = true;
                    requestAnimationFrame(tick);
                })
                .catch(function(error) {
                    console.error(error);
                });
        }

        //function requestcpermission() {
        //    return new Promise(function(resolve, reject) {
        //        navigator.permissions.query({ name: "camera" })
        //            .then(function(permissiongranted){
        //                if (permissionStatus.state == "granted") {
        //                    resolve(true);
        //                } else if (permissionStatus.state == "prompt") {
        //                    navigator.mediaDevices.getUserMedia({ video: true })
        //                        .then(function(stream) {
        //                            stream.getTracks().forEach(function(track) {
        //                                track.stop();
        //                            });
        //                            resolve(true);
        //                        })
        //                        .catch(function(error) {
        //                            console.error(error);
        //                            resolve(false);
        //                        });
        //                } else {
        //                    resolve(false);
        //                }
        //            });
        //    });
        //}

        //function startCamera() {
        //    if (permissiongranted) {
        //        requestcpermission().then(function(granted) {
        //            if (granted) {
        //                permissiongranted = true;
        //                startCameraStream();
        //            }
        //        });
        //    } else {
        //        startCameraStream();
        //    }
        //}

        function tick() {
            loadingMessage.innerText = "Loading video..."
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                loadingMessage.hidden = true;
                canvasElement.hidden = false;
                outputContainer.hidden = false;

                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                var code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });
                if (code) {
                    drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
                    drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
                    drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
                    drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");
                    outputMessage.hidden = true;
                    outputData.parentElement.hidden = false;
                    outputData.innerText = code.data;
                    stopCamera();
                    qr2array(code.data);
                } else {
                    outputMessage.hidden = false;
                    outputData.parentElement.hidden = true;
                }
            }
            requestAnimationFrame(tick);
        }

        var qrry = [];
        var qrflag = false;
        var epsfig = document.getElementById("chiwakufigure")
        var group1 = document.getElementById("fluidspace")
        var icon1 = document.getElementById("fs_i")
        var group2 = document.getElementById("solidearth")
        var icon2 = document.getElementById("se_i")
        var group3 = document.getElementById("solarsystem")
        var icon3 = document.getElementById("ss_i")

        function qr2array(loadedtext) {
            qrry.push(String(loadedtext));
            if (qrry.includes("Earth") && qrry.includes("Planetary") && qrry.includes("Sciences")) {
                //qrflag = true;
                epsfig.style.display = "block";
            }
            if (qrry.includes("Earth")) {
                group1.style.color = "#0066CC";
                icon1.style.display = "inline";
            }
            if (qrry.includes("Planetary")) {
                group2.style.color = "#FF8548";
                icon2.style.display = "inline";
            }
            if (qrry.includes("Sciences")) {
                group3.style.color = "#4C9900";
                icon3.style.display = "inline";
            }
        }
    </script>
    <!-- MDB -->
    <script type="text/javascript" src="js/mdb.min.js"></script>
    <script src="js/jsQR.js"></script>
    </body>
</html>
